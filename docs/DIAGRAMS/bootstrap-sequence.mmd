sequenceDiagram
    autonumber
    participant N as Node
    participant D as Discovery
    participant S as Supervisor
    participant GW as API-Gateway
    participant MQ as RabbitMQ

    Note over D: Boot → read/create node_id

    D->>S: Register node
    S-->>D: Ok registered
    D->>S: Request plan

    S-->>D: Plan { role, services[], epoch, ttl, urls }

    D->>D: Apply plan → write cluster.json → (start/stop) services


    D->>S: Heartbeat role and services running
    S-->>MQ: overlay heartbeat

    par Environment reconcile (idempotent)
        D->>S: Get environment profile
        D->>D: Reconcile storage → broker → index
        D->>S: Bootstrap events per component
    end

    Note over GW,S: Frontend reads logical state through gateway or supervisor
